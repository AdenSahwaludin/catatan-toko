<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supabase Debug</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        background: #1e1e1e;
        color: #ffffff;
        padding: 20px;
        margin: 0;
      }
      .log {
        margin: 5px 0;
        padding: 5px;
      }
      .error {
        color: #ff6b6b;
      }
      .success {
        color: #51cf66;
      }
      .info {
        color: #74c0fc;
      }
      .warning {
        color: #ffd43b;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      button {
        background: #339af0;
        color: white;
        border: none;
        padding: 10px 15px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #228be6;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔍 Supabase Connection Debug</h1>
      <div id="output"></div>
      <div>
        <button onclick="runDebug()">🔄 Run Full Debug</button>
        <button onclick="clearLog()">🧹 Clear Log</button>
        <button onclick="testAuth()">🔐 Test Auth</button>
        <button onclick="testTables()">📊 Test Tables</button>
        <button onclick="testInsert()">➕ Test Insert</button>
      </div>
    </div>

    <script type="module">
      const output = document.getElementById("output");

      function log(message, type = "info") {
        const div = document.createElement("div");
        div.className = `log ${type}`;
        div.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
        output.appendChild(div);
        output.scrollTop = output.scrollHeight;
        console.log(message);
      }

      window.log = log;

      function clearLog() {
        output.innerHTML = "";
      }
      window.clearLog = clearLog;

      // Load environment variables from the .env file values
      const config = {
        supabaseUrl: "https://mjxhddjoaoekdlhnqbhy.supabase.co",
        supabaseAnonKey:
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qeGhkZGpvYW9la2RsaG5xYmh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNTgxMTQsImV4cCI6MjA2OTczNDExNH0.XyPUtr2KgiZwMqbz_2hS0e-UTVqhS-ucZedo0pT9Qss",
      };

      // Create Supabase client
      const { createClient } = await import(
        "https://esm.sh/@supabase/supabase-js@2"
      );
      const supabase = createClient(config.supabaseUrl, config.supabaseAnonKey);

      window.supabase = supabase;

      async function testAuth() {
        log("🔐 Testing authentication...", "info");
        try {
          const { data, error } = await supabase.auth.getUser();
          if (error) {
            log(`❌ Auth error: ${error.message}`, "error");
          } else if (data.user) {
            log(`✅ Authenticated as: ${data.user.email}`, "success");
          } else {
            log("⚠️  Not authenticated", "warning");
          }
        } catch (err) {
          log(`❌ Auth exception: ${err.message}`, "error");
        }
      }

      async function testTables() {
        log("📊 Testing database tables...", "info");
        const tables = ["categories", "items", "sales", "users"];

        for (const tableName of tables) {
          try {
            log(`   Testing ${tableName} table...`);
            const { data, error, count } = await supabase
              .from(tableName)
              .select("*", { count: "exact" })
              .limit(1);

            if (error) {
              log(`   ❌ ${tableName}: ${error.message}`, "error");
            } else {
              log(`   ✅ ${tableName}: ${count || 0} records`, "success");
              if (data && data.length > 0) {
                log(`      Columns: ${Object.keys(data[0]).join(", ")}`);
              }
            }
          } catch (err) {
            log(`   ❌ ${tableName}: ${err.message}`, "error");
          }

          // Small delay
          await new Promise((resolve) => setTimeout(resolve, 200));
        }
      }

      async function testInsert() {
        log("➕ Testing insert permissions...", "info");
        try {
          const testName = `TEST_${Date.now()}`;
          log(`   Attempting to insert category: ${testName}`);

          const { data, error } = await supabase
            .from("categories")
            .insert({ name: testName })
            .select();

          if (error) {
            log(`   ❌ Insert failed: ${error.message}`, "error");
          } else {
            log(`   ✅ Insert successful`, "success");

            // Clean up
            log(`   🧹 Cleaning up test data...`);
            const { error: deleteError } = await supabase
              .from("categories")
              .delete()
              .eq("id", data[0].id);

            if (deleteError) {
              log(`   ⚠️  Cleanup failed: ${deleteError.message}`, "warning");
            } else {
              log(`   ✅ Cleanup successful`, "success");
            }
          }
        } catch (err) {
          log(`   ❌ Insert exception: ${err.message}`, "error");
        }
      }

      async function runDebug() {
        clearLog();
        log("🚀 Starting full debug session...", "info");
        log(`📡 Supabase URL: ${config.supabaseUrl}`, "info");
        log(
          `🔑 API Key: ${config.supabaseAnonKey.substring(0, 20)}...`,
          "info"
        );

        await testAuth();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testTables();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testInsert();

        log("✅ Debug session complete!", "success");
        log("💡 If you see errors, check:", "info");
        log("   1. Supabase project is active and not paused", "info");
        log("   2. Database tables exist", "info");
        log("   3. RLS policies allow operations", "info");
        log("   4. API keys are correct and not expired", "info");
      }

      // Expose functions globally
      window.testAuth = testAuth;
      window.testTables = testTables;
      window.testInsert = testInsert;
      window.runDebug = runDebug;

      // Auto-run on load
      log('🎯 Debug tool loaded. Click "Run Full Debug" to start!', "info");
    </script>
  </body>
</html>
